{% extends 'dashboard/base.html' %}

{% block title %}Purchase Subscription - Phonix{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-white mb-8">Purchase Subscription</h1>

    <!-- Current Balance Card -->
    <div class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-lg shadow-lg p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-white text-sm opacity-90">Wallet Balance</p>
                <p class="text-white text-3xl font-bold">${{ user.wallet_balance }}</p>
            </div>
            <div>
                <p class="text-white text-sm opacity-90">Registration Bonus</p>
                <p class="text-white text-3xl font-bold">${{ user.registration_bonus }}</p>
            </div>
        </div>
    </div>

    <!-- Tier Information -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-gray-800 rounded-lg p-6 border-2 border-indigo-500">
            <h3 class="text-xl font-bold text-white mb-2">Tier 1</h3>
            <p class="text-gray-300 text-sm mb-4">$50 - $3,000</p>
            <div class="space-y-2">
                <p class="text-white"><span class="text-indigo-400">Rate:</span> 6% monthly</p>
                <p class="text-white"><span class="text-indigo-400">Daily:</span> ~0.2%</p>
                <p class="text-white"><span class="text-indigo-400">Cap:</span> 3x investment</p>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6 border-2 border-purple-500">
            <h3 class="text-xl font-bold text-white mb-2">Tier 2</h3>
            <p class="text-gray-300 text-sm mb-4">$3,001 - $5,000</p>
            <div class="space-y-2">
                <p class="text-white"><span class="text-purple-400">Rate:</span> 8% monthly</p>
                <p class="text-white"><span class="text-purple-400">Daily:</span> ~0.27%</p>
                <p class="text-white"><span class="text-purple-400">Cap:</span> 3x investment</p>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6 border-2 border-pink-500">
            <h3 class="text-xl font-bold text-white mb-2">Tier 3</h3>
            <p class="text-gray-300 text-sm mb-4">$5,001+</p>
            <div class="space-y-2">
                <p class="text-white"><span class="text-pink-400">Rate:</span> 10% monthly</p>
                <p class="text-white"><span class="text-pink-400">Daily:</span> ~0.33%</p>
                <p class="text-white"><span class="text-pink-400">Cap:</span> 3x investment</p>
            </div>
        </div>
    </div>

    <!-- Purchase Form -->
    <div class="bg-gray-800 rounded-lg shadow-lg p-8">
        <h2 class="text-2xl font-bold text-white mb-6">Purchase Details</h2>

        <form method="post" id="purchaseForm">
            {% csrf_token %}

            <div class="mb-6">
                <label for="amount" class="block text-white font-semibold mb-2">
                    Subscription Amount (USD)
                </label>
                <input type="number" name="amount" id="amount" min="50" step="0.01"
                    class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="Enter amount (minimum $50)" required oninput="calculatePurchase()">
                <p class="text-gray-400 text-sm mt-2">Minimum: $50</p>
            </div>

            {% if user.registration_bonus > 0 %}
            <div class="mb-6">
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" name="use_bonus" id="use_bonus"
                        class="w-5 h-5 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500"
                        onchange="calculatePurchase()">
                    <span class="text-white">
                        Use Registration Bonus (Available: ${{ user.registration_bonus }})
                    </span>
                </label>
                <p class="text-gray-400 text-sm mt-2 ml-8">
                    Maximum 10% of subscription amount can be paid with bonus
                </p>
            </div>
            {% endif %}

            <!-- Calculation Summary -->
            <div class="bg-gray-700 rounded-lg p-6 mb-6" id="calculationSummary" style="display: none;">
                <h3 class="text-lg font-bold text-white mb-4">Purchase Summary</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-300">Subscription Amount:</span>
                        <span class="text-white font-semibold" id="summaryAmount">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Tier:</span>
                        <span class="text-white font-semibold" id="summaryTier">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Monthly Rate:</span>
                        <span class="text-white font-semibold" id="summaryRate">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Bonus Used:</span>
                        <span class="text-green-400 font-semibold" id="summaryBonus">$0.00</span>
                    </div>
                    <div class="border-t border-gray-600 pt-3 mt-3">
                        <div class="flex justify-between">
                            <span class="text-white font-bold">Required from Wallet:</span>
                            <span class="text-white font-bold text-xl" id="summaryRequired">$0.00</span>
                        </div>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Your Wallet Balance:</span>
                        <span class="text-white font-semibold">${{ user.wallet_balance }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Balance After Purchase:</span>
                        <span class="font-semibold" id="summaryBalance">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="flex space-x-4">
                <button type="submit"
                    class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:from-indigo-600 hover:to-purple-700 transition duration-300">
                    Purchase Subscription
                </button>
                <a href="{% url 'dashboard:index' %}"
                    class="flex-1 bg-gray-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition duration-300 text-center">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    function calculatePurchase() {
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const useBonus = document.getElementById('use_bonus')?.checked || false;
        const availableBonus = {{ user.registration_bonus } }; const walletBalance = {{ user.wallet_balance }};

    if (amount < 50) {
        document.getElementById('calculationSummary').style.display = 'none';
        return;
    }

    // Calculate tier and rate
    let tier, rate;
    if (amount <= 3000) {
        tier = 'Tier 1';
        rate = '6%';
    } else if (amount <= 5000) {
        tier = 'Tier 2';
        rate = '8%';
    } else {
        tier = 'Tier 3';
        rate = '10%';
    }

    // Calculate bonus usage
    const maxBonus = amount * 0.10;
    const bonusUsed = useBonus ? Math.min(availableBonus, maxBonus) : 0;
    const requiredAmount = amount - bonusUsed;
    const balanceAfter = walletBalance - requiredAmount;

    // Update summary
    document.getElementById('summaryAmount').textContent = '$' + amount.toFixed(2);
    document.getElementById('summaryTier').textContent = tier;
    document.getElementById('summaryRate').textContent = rate + ' monthly';
    document.getElementById('summaryBonus').textContent = '$' + bonusUsed.toFixed(2);
    document.getElementById('summaryRequired').textContent = '$' + requiredAmount.toFixed(2);

    const balanceElement = document.getElementById('summaryBalance');
    balanceElement.textContent = '$' + balanceAfter.toFixed(2);
    balanceElement.className = balanceAfter >= 0 ? 'text-green-400 font-semibold' : 'text-red-400 font-semibold';

    document.getElementById('calculationSummary').style.display = 'block';
}
</script>
{% endblock %}